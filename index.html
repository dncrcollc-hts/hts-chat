<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTS Chat</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b1220; color:#eaeef5; margin:0; }
    #chat { max-width:780px; margin:32px auto; background:#111a2e; border-radius:16px; padding:16px; box-shadow:0 4px 20px rgba(0,0,0,.25); }
    .msg { padding:10px 12px; margin:8px 0; border-radius:12px; max-width: 85%; line-height:1.35; white-space:pre-wrap }
    .user { background:#2544ff; margin-left:auto }
    .bot  { background:#1a2440 }
    #row { display:flex; gap:8px; margin-top:12px }
    input[type=text]{ flex:1; padding:12px; border-radius:10px; border:1px solid #2a3558; background:#0e162b; color:#eaeef5 }
    button{ padding:12px 16px; border-radius:10px; border:0; background:#2544ff; color:white; cursor:pointer }
    .choice { display:inline-block; background:#223057; padding:6px 10px; border-radius:8px; margin:6px 6px 0 0; cursor:pointer }
    .small { opacity:.8; font-size:.9em }
    a { color:#8fb3ff }
  </style>
</head>
<body>
  <div id="chat">
    <div id="log"></div>
    <div id="row">
      <input id="input" type="text" placeholder="Type your message…" autofocus />
      <button id="send">Send</button>
    </div>
  </div>

<script>
// TODO: replace with your PRODUCTION n8n URLs (not test)
const CLASSIFY_URL = "https://YOUR-RCLD-DOMAIN/webhook/classify";
const ANSWER_URL   = "https://YOUR-RCLD-DOMAIN/webhook/answer";

const log = document.getElementById('log');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

let session = null;
let stage   = 'await_hts6';
let currentQid = null;

function add(text, who='bot', html=false){
  const div = document.createElement('div');
  div.className = `msg ${who}`;
  div[html ? 'innerHTML' : 'textContent'] = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}
function addChoices(choices){
  const wrap = document.createElement('div');
  (choices || []).forEach(c=>{
    const span = document.createElement('span');
    span.className = 'choice';
    span.textContent = c.label || c.id;
    span.dataset.id = c.id;
    span.onclick = ()=> handleChoice(c.id);
    wrap.appendChild(span);
  });
  log.appendChild(wrap);
  log.scrollTop = log.scrollHeight;
}

async function call(url, body){
  const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function handleSend(){
  const text = input.value.trim();
  if (!text) return;
  add(text, 'user'); input.value='';

  try {
    if (stage === 'await_hts6') {
      const m = text.match(/(\d{6})(?:\s+(.+))?/);
      if (!m){ add("Please send a 6-digit HTS (e.g., 940161) and optional description, e.g.:\n940161 upholstered wood chair", 'bot'); return; }
      const hts6 = m[1];
      const description = m[2] || '';
      const res = await call(CLASSIFY_URL, { hts6, description });
      session = res.session;
      stage = 'confirm_hts6';
      add(`Confirm 6-digit ${res.hts6}\n${res.explanation}`, 'bot');
      addChoices(res.choices);
      return;
    }

    if (stage === 'ask') {
      add("Please tap a choice below.", 'bot');
      return;
    }

    if (stage === 'confirm_hts6') {
      add("Tap one of the buttons: Yes / No", 'bot');
      return;
    }
  } catch (e) {
    add(`Error: ${e.message}`, 'bot');
  }
}

async function handleChoice(answerId){
  add(answerId, 'user');
  try {
    if (stage === 'confirm_hts6') {
      const res = await call(ANSWER_URL, { session, qid: null, answerId });
      if (res.stage === 'triage'){ add(res.message, 'bot'); return; }
      if (res.stage === 'ask'){
        session = res.session;
        stage = 'ask';
        currentQid = res.qid;
        add(res.text, 'bot');
        addChoices(res.choices);
        return;
      }
    } else if (stage === 'ask') {
      const res = await call(ANSWER_URL, { session, qid: currentQid, answerId });
      if (res.stage === 'ask'){
        session = res.session;
        currentQid = res.qid;
        add(res.text, 'bot');
        addChoices(res.choices);
        return;
      }
      if (res.stage === 'done'){
        add(`✅ 10-digit HTS: ${res.hts10}`, 'bot', true);
        add(`<div class="small">Reason: ${res.rationale}</div>`, 'bot', true);
        stage = 'done';
        return;
      }
      if (res.stage === 'unresolved'){
        add("I need one more rule row for this combination. Please add it in the Google Sheet (rules tab).", 'bot');
        stage = 'await_hts6';
        session = null;
        add("You can start again by sending a new 6-digit HTS.", 'bot');
        return;
      }
    }
  } catch (e) {
    add(`Error: ${e.message}`, 'bot');
  }
}

// greeting
add("Hi! Send your 6-digit HTS (e.g., 940161) and optional description, like:\n`940161 upholstered wood chair`");

sendBtn.onclick = handleSend;
input.addEventListener('keydown', e => { if (e.key === 'Enter') handleSend(); });
</script>
</body>
</html>

